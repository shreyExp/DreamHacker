<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Dream Hacker: PulseSensor.h Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="LogoDreamHacker.jpeg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Dream Hacker
   </div>
   <div id="projectbrief">DreamHacker is a flexible tool which allows user to learn their sleep cycle, beats and other biological information about their sleep. It helps in mannipuation their dreams for more comfortable sleep using sound stimulus.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">PulseSensor.h</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="preprocessor">#include &quot;CppTimer.h&quot;</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160; </div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160; </div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">// MCP3004/8 SETTINGS</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="preprocessor">#define BASE 100</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="preprocessor">#define SPI_CHAN 0</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160; </div>
<div class="line"><a name="l00012"></a><span class="lineno"><a class="line" href="classSensorCallback.html">   12</a></span>&#160;<span class="keyword">class </span><a class="code" href="classSensorCallback.html">SensorCallback</a> {</div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="keyword">public</span>:</div>
<div class="line"><a name="l00017"></a><span class="lineno"><a class="line" href="classSensorCallback.html#ac8bc6b4797f2e2b1d9612e1e1f834fbd">   17</a></span>&#160;    <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="classSensorCallback.html#ac8bc6b4797f2e2b1d9612e1e1f834fbd">hasSample</a>(<span class="keywordtype">int</span> beats, <span class="keywordtype">bool</span> mayBeSleep) = 0;</div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;};</div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160; </div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160; </div>
<div class="line"><a name="l00021"></a><span class="lineno"><a class="line" href="classSensorTimer.html">   21</a></span>&#160;<span class="keyword">class </span><a class="code" href="classSensorTimer.html">SensorTimer</a> : <span class="keyword">public</span> <a class="code" href="classCppTimer.html">CppTimer</a> {</div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;    <span class="keyword">private</span>:</div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;        <a class="code" href="classSensorCallback.html">SensorCallback</a>* sensorCallback = <span class="keyword">nullptr</span>;</div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;    <span class="keyword">private</span>:</div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;        <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> eventCounter, thisTime, lastTime, elapsedTime;</div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;        <span class="keywordtype">int</span> sampleFlag = 0;</div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;        <span class="keywordtype">int</span> firstTime, secondTime, duration;</div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;        <span class="keywordtype">int</span> timeOutStart, dataRequestStart, m;</div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;        <span class="keywordtype">int</span> Signal;</div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;        <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> sampleCounter;</div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;        <span class="keywordtype">int</span> threshSetting,lastBeatTime;</div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;        <span class="keywordtype">int</span> thresh = 550;</div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;        <span class="keywordtype">int</span> P = 512;                               <span class="comment">// set P default</span></div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;        <span class="keywordtype">int</span> T = 512;                               <span class="comment">// set T default</span></div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;        <span class="keywordtype">int</span> firstBeat = 1;                      <span class="comment">// set these to avoid noise</span></div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;        <span class="keywordtype">int</span> secondBeat = 0;                    <span class="comment">// when we get the heartbeat back</span></div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;        <span class="keywordtype">int</span> QS = 0;</div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;        <span class="keywordtype">int</span> rate[10];</div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;        <span class="keywordtype">int</span> BPM = 0;</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;        <span class="keywordtype">int</span> IBI = 600;                  <span class="comment">// 600ms per beat = 100 Beats Per Minute (BPM)</span></div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;        <span class="keywordtype">int</span> Pulse = 0;</div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;        <span class="keywordtype">int</span> amp = 100;                  <span class="comment">// beat amplitude 1/10 of input range.</span></div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;        <span class="keywordtype">int</span> call_time_period = 2000; <span class="comment">//in microseconds 2 milli s</span></div>
<div class="line"><a name="l00047"></a><span class="lineno"><a class="line" href="classSensorTimer.html#a4d29fdf6804a4777668d957a8333f9c6">   47</a></span>&#160;<span class="comment"></span>        time_t <a class="code" href="classSensorTimer.html#a4d29fdf6804a4777668d957a8333f9c6">nightTime</a>;</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;        time_t wakeTime;</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;        <span class="keywordtype">int</span> bpmThreshold = 77;</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;        <span class="keywordtype">bool</span> maybeSleep = 0;</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;        time_t surelySleptTime = 2;</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;        <span class="keywordtype">bool</span> sleep;</div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;        time_t startOfProspectiveSleep; </div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;        <span class="keywordtype">bool</span> is_audio_playing; </div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;        <span class="keywordtype">bool</span> play_audio_locally;</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;        pid_t audio_pid;</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;        <span class="keywordtype">char</span> audio_name[500];</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;        <span class="keywordtype">bool</span> is_simulation = 0;</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;    <span class="keyword">public</span>:</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;        <a class="code" href="classSensorTimer.html">SensorTimer</a>(<span class="keywordtype">int</span>);</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;        <span class="keywordtype">void</span> <a class="code" href="classSensorTimer.html#a2b87e348b476be96d88ee70be98bef11">setCallback</a>(<a class="code" href="classSensorCallback.html">SensorCallback</a>* cb);</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;        <span class="keywordtype">void</span> <a class="code" href="classSensorTimer.html#a6d15ff3f37f39e6baa43cf22a48263f2">timerEvent</a>(); </div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;        <span class="keywordtype">void</span> initPulseSensorVariables(<span class="keywordtype">void</span>);</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;        <span class="keywordtype">void</span> getPulse(<span class="keywordtype">void</span>);</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;        <span class="keywordtype">bool</span> <a class="code" href="classSensorTimer.html#a36233c0d18fe087bbfcf3a37bdf6dcec">analyzeBeatsForSleep</a>(<span class="keywordtype">int</span> bpm);</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;        <span class="keywordtype">void</span> initializeVariablesForSleep(<span class="keywordtype">void</span>);</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;        <span class="keywordtype">void</span> audioprocess();</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;        pid_t play_audio(<span class="keywordtype">char</span>* audio_name);</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;        <span class="keywordtype">void</span> kill_the_pid(pid_t x);</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;        <span class="keywordtype">void</span> beatsPerMinuteSimulation();</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;        time_t start_of_simulation;</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;        <span class="keywordtype">bool</span> simulation_started = 0;</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;};</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160; </div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;SensorTimer::SensorTimer(<span class="keywordtype">int</span> mode){</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;    <span class="keywordflow">if</span>(mode &gt; 0)</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;        is_simulation = 1;</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;    initPulseSensorVariables();</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;    initializeVariablesForSleep();</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;        FILE *fptr;</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;        <span class="keywordflow">if</span> ((fptr = fopen(<span class="stringliteral">&quot;audio.txt&quot;</span>, <span class="stringliteral">&quot;r&quot;</span>)) == NULL) {</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;            printf(<span class="stringliteral">&quot;Error! opening audio.txt&quot;</span>);</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;        play_audio_locally = 0;</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;        }<span class="keywordflow">else</span>{</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;              fscanf(fptr,<span class="stringliteral">&quot;%s&quot;</span>, audio_name);</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;              fclose(fptr);</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;              play_audio_locally = 1;</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;        }</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;}</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;<span class="keywordtype">void</span> SensorTimer::audioprocess(){</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;    <span class="keywordflow">if</span>(sleep == 1 &amp;&amp; is_audio_playing == 0 &amp;&amp; play_audio_locally){</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;              audio_pid = play_audio(audio_name);</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;              <span class="comment">/*</span></div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;<span class="comment">               * If child process then the audio is already ended, pid must kill itself safely</span></div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;<span class="comment">               */</span></div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;              <span class="keywordflow">if</span>(audio_pid == 0){</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;                <span class="keyword">raise</span>(SIGKILL);</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;              }<span class="keywordflow">else</span>{</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;            <span class="comment">/*</span></div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;<span class="comment">             * If parent process then continue and put the is_audio_playing flag to be true</span></div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;<span class="comment">             */</span></div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;                is_audio_playing = 1;</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;            printf(<span class="stringliteral">&quot;Audio pid is %d\n&quot;</span>, audio_pid);</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;              }</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;    }</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(is_audio_playing == 1 &amp;&amp; sleep == 0 &amp;&amp; play_audio_locally){</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;              <span class="comment">/*</span></div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;<span class="comment">               * When the person wakes up again kill the pid which runs the audio</span></div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;<span class="comment">               */</span></div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;              <span class="keywordflow">if</span>(audio_pid &gt; 0){</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;            printf(<span class="stringliteral">&quot;Kill Reached Here\n&quot;</span>);</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;                kill_the_pid(audio_pid);</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;                is_audio_playing = 0;</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;              }</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;    }</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;}</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;pid_t SensorTimer::play_audio(<span class="keywordtype">char</span>* audio_name){</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;    pid_t audio_pid_local;</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;    <span class="keywordflow">if</span>(0 == (audio_pid_local = fork())){</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;        <span class="comment">//child process</span></div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;        <span class="comment">//printf(&quot;reached here\n&quot;);</span></div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;        printf(<span class="stringliteral">&quot;Reached Here pid is %d\n&quot;</span>, audio_pid_local);</div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;        execlp(<span class="stringliteral">&quot;mpg123&quot;</span>, <span class="stringliteral">&quot;mpg123&quot;</span>, <span class="stringliteral">&quot;-q&quot;</span>, audio_name, 0);</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;        is_audio_playing = 1;</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;    }</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;    is_audio_playing = 1;</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;    <span class="keywordflow">return</span> audio_pid_local;</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;}</div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160; </div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;<span class="keywordtype">void</span> SensorTimer::kill_the_pid(pid_t x){</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;    <span class="keywordtype">char</span> kil[100] = <span class="stringliteral">&quot;kill -9 &quot;</span>;</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;    sprintf(kil,<span class="stringliteral">&quot;%s%d&quot;</span>,kil, x);</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;    <span class="comment">//system(kil);</span></div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;    kill(x,SIGINT);</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;}</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160; </div>
<div class="line"><a name="l00140"></a><span class="lineno"><a class="line" href="classSensorTimer.html#a2b87e348b476be96d88ee70be98bef11">  140</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classSensorTimer.html#a2b87e348b476be96d88ee70be98bef11">SensorTimer::setCallback</a>(<a class="code" href="classSensorCallback.html">SensorCallback</a>* cb) {</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;    printf(<span class="stringliteral">&quot;pointer: %p\n&quot;</span>, cb);</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;    sensorCallback = cb;</div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;}</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160; </div>
<div class="line"><a name="l00145"></a><span class="lineno"><a class="line" href="classSensorTimer.html#a6d15ff3f37f39e6baa43cf22a48263f2">  145</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classSensorTimer.html#a6d15ff3f37f39e6baa43cf22a48263f2">SensorTimer::timerEvent</a>() {</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;    getPulse();</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;    <span class="keywordflow">if</span>(is_simulation)</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;        beatsPerMinuteSimulation();</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;    sleep = <a class="code" href="classSensorTimer.html#a36233c0d18fe087bbfcf3a37bdf6dcec">analyzeBeatsForSleep</a>(BPM);</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;    printf(<span class="stringliteral">&quot;Value is: %d\n&quot;</span>, BPM);</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;    audioprocess();</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;    printf(<span class="stringliteral">&quot;BPM is: %d\n&quot;</span>, BPM);</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;    printf(<span class="stringliteral">&quot;Sleep is: %d\n&quot;</span>, sleep);</div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">nullptr</span> != sensorCallback) {</div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;      sensorCallback-&gt;<a class="code" href="classSensorCallback.html#ac8bc6b4797f2e2b1d9612e1e1f834fbd">hasSample</a>(BPM, sleep);</div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;  }</div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;    fflush(stdout);</div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;}</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160; </div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;<span class="keywordtype">void</span> SensorTimer::beatsPerMinuteSimulation(){</div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;    <span class="keywordflow">if</span>(simulation_started == 0){</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;        start_of_simulation = time(NULL);</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;        simulation_started = 1;</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;    }</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;    <span class="keywordtype">int</span> begin_bpm = 80;</div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;    <span class="keywordtype">int</span> end_bpm = 60;</div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;    time_t durationOfSimulation = 60*1; <span class="comment">//5 minute duration</span></div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;    <span class="keywordtype">float</span> slope = (float)(end_bpm - begin_bpm)/(float)(durationOfSimulation/2);</div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;    <span class="keywordtype">int</span> t = time(NULL) - start_of_simulation;</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;    <span class="comment">//Downwards</span></div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;    <span class="keywordtype">int</span> sim_bpm = begin_bpm;</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;    <span class="comment">//printf(&quot;slope is %f\n&quot;,slope);</span></div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;    <span class="keywordflow">if</span>(t &lt; durationOfSimulation/2)</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;        sim_bpm = (int)(slope*t) + begin_bpm;</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;    <span class="comment">//Upwards</span></div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(t &gt;= durationOfSimulation/2 &amp;&amp; t &lt;= durationOfSimulation){</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;        t = t - (durationOfSimulation/2);</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;        sim_bpm = -1 * (int)(slope*t) + end_bpm;</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;    }</div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;    BPM = sim_bpm;</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160; </div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;    </div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160; </div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160; </div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;}</div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160; </div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;<span class="keywordtype">void</span> SensorTimer::initPulseSensorVariables(<span class="keywordtype">void</span>){</div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;    </div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;    wiringPiSetup(); <span class="comment">//use the wiringPi pin numbers</span></div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;    mcp3004Setup(BASE,SPI_CHAN);    <span class="comment">// setup the mcp3004 library</span></div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;    <span class="comment">//pinMode(BLINK_LED, OUTPUT); digitalWrite(BLINK_LED,LOW);</span></div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160; </div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160; </div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 10; ++i) {</div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;        rate[i] = 0;</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;    }</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;    QS = 0;</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;    BPM = 0;</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;    IBI = 600;                  <span class="comment">// 600ms per beat = 100 Beats Per Minute (BPM)</span></div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;    Pulse = 0;</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;    sampleCounter = 0;</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;    lastBeatTime = 0;</div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;    P = 512;                    <span class="comment">// peak at 1/2 the input range of 0..1023</span></div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;    T = 512;                    <span class="comment">// trough at 1/2 the input range.</span></div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;    threshSetting = 550;        <span class="comment">// used to seed and reset the thresh variable</span></div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;    thresh = 550;     <span class="comment">// threshold a little above the trough</span></div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;    amp = 100;                  <span class="comment">// beat amplitude 1/10 of input range.</span></div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;    firstBeat = 1;           <span class="comment">// looking for the first beat</span></div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;    secondBeat = 0;         <span class="comment">// not yet looking for the second beat in a row</span></div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;    lastTime = micros();</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;    timeOutStart = lastTime;</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;    call_time_period = 2000; <span class="comment">//in microseconds 2 milli s</span></div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;}</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160; </div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;<span class="keywordtype">void</span> SensorTimer::getPulse(<span class="keywordtype">void</span>){</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160; </div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;        thisTime = micros();</div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;        Signal = analogRead(BASE);</div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;        elapsedTime = thisTime - lastTime;</div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;        lastTime = thisTime;</div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;        sampleFlag = 1;</div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160; </div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160; </div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;      sampleCounter += 2;         <span class="comment">// keep track of the time in mS with this variable</span></div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;      <span class="keywordtype">int</span> N = sampleCounter - lastBeatTime;      <span class="comment">// monitor the time since the last beat to avoid noise</span></div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;    </div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;    <span class="comment">// FADE LED HERE, IF WE COULD FADE...</span></div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;    </div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;      <span class="comment">//  find the peak and trough of the pulse wave</span></div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;      <span class="keywordflow">if</span> (Signal &lt; thresh &amp;&amp; N &gt; (IBI / 5) * 3) { <span class="comment">// avoid dichrotic noise by waiting 3/5 of last IBI</span></div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;        <span class="keywordflow">if</span> (Signal &lt; T) {                        <span class="comment">// T is the trough</span></div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;          T = Signal;                            <span class="comment">// keep track of lowest point in pulse wave</span></div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;        }</div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;      }</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;    </div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;      <span class="keywordflow">if</span> (Signal &gt; thresh &amp;&amp; Signal &gt; P) {       <span class="comment">// thresh condition helps avoid noise</span></div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;        P = Signal;                              <span class="comment">// P is the peak</span></div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;      }                                          <span class="comment">// keep track of highest point in pulse wave</span></div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;    </div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;      <span class="comment">//  NOW IT&#39;S TIME TO LOOK FOR THE HEART BEAT</span></div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;      <span class="comment">// signal surges up in value every time there is a pulse</span></div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;      <span class="keywordflow">if</span> (N &gt; 250) {                             <span class="comment">// avoid high frequency noise</span></div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;        <span class="keywordflow">if</span> ( (Signal &gt; thresh) &amp;&amp; (Pulse == 0) &amp;&amp; (N &gt; ((IBI / 5) * 3)) ) {</div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;          Pulse = 1;                             <span class="comment">// set the Pulse flag when we think there is a pulse</span></div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;          IBI = sampleCounter - lastBeatTime;    <span class="comment">// measure time between beats in mS</span></div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;          lastBeatTime = sampleCounter;          <span class="comment">// keep track of time for next pulse</span></div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;    </div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;          <span class="keywordflow">if</span> (secondBeat) {                      <span class="comment">// if this is the second beat, if secondBeat == TRUE</span></div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;            secondBeat = 0;                      <span class="comment">// clear secondBeat flag</span></div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt;= 9; i++) {       <span class="comment">// seed the running total to get a realisitic BPM at startup</span></div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;              rate[i] = IBI;</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;            }</div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;          }</div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;    </div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;          <span class="keywordflow">if</span> (firstBeat) {                       <span class="comment">// if it&#39;s the first time we found a beat, if firstBeat == TRUE</span></div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;            firstBeat = 0;                       <span class="comment">// clear firstBeat flag</span></div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;            secondBeat = 1;                      <span class="comment">// set the second beat flag</span></div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;            <span class="comment">// IBI value is unreliable so discard it</span></div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;            <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;          }</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;    </div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;    </div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;          <span class="comment">// keep a running total of the last 10 IBI values</span></div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;          <span class="keywordtype">int</span> runningTotal = 0;                  <span class="comment">// clear the runningTotal variable</span></div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;    </div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;          <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt;= 8; i++) {          <span class="comment">// shift data in the rate array</span></div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;            rate[i] = rate[i + 1];                <span class="comment">// and drop the oldest IBI value</span></div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;            runningTotal += rate[i];              <span class="comment">// add up the 9 oldest IBI values</span></div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;          }</div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;    </div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;          rate[9] = IBI;                          <span class="comment">// add the latest IBI to the rate array</span></div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;          runningTotal += rate[9];                <span class="comment">// add the latest IBI to runningTotal</span></div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;          runningTotal /= 10;                     <span class="comment">// average the last 10 IBI values</span></div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;          BPM = 60000 / runningTotal;             <span class="comment">// how many beats can fit into a minute? that&#39;s BPM!</span></div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;          QS = 1;                              <span class="comment">// set Quantified Self flag (we detected a beat)</span></div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;          <span class="comment">//fadeLevel = MAX_FADE_LEVEL;             // If we&#39;re fading, re-light that LED.</span></div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;        }</div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;      }</div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;    </div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;      <span class="keywordflow">if</span> (Signal &lt; thresh &amp;&amp; Pulse == 1) {  <span class="comment">// when the values are going down, the beat is over</span></div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;        Pulse = 0;                         <span class="comment">// reset the Pulse flag so we can do it again</span></div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;        amp = P - T;                           <span class="comment">// get amplitude of the pulse wave</span></div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;        thresh = amp / 2 + T;                  <span class="comment">// set thresh at 50% of the amplitude</span></div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;        P = thresh;                            <span class="comment">// reset these for next time</span></div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;        T = thresh;</div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;      }</div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;    </div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;      <span class="keywordflow">if</span> (N &gt; 2500) {                          <span class="comment">// if 2.5 seconds go by without a beat</span></div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;        thresh = threshSetting;                <span class="comment">// set thresh default</span></div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;        P = 512;                               <span class="comment">// set P default</span></div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;        T = 512;                               <span class="comment">// set T default</span></div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;        lastBeatTime = sampleCounter;          <span class="comment">// bring the lastBeatTime up to date</span></div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;        firstBeat = 1;                      <span class="comment">// set these to avoid noise</span></div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;        secondBeat = 0;                    <span class="comment">// when we get the heartbeat back</span></div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;        QS = 0;</div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;        BPM = 0;</div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;        IBI = 600;                  <span class="comment">// 600ms per beat = 100 Beats Per Minute (BPM)</span></div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;        Pulse = 0;</div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;        amp = 100;                  <span class="comment">// beat amplitude 1/10 of input range.</span></div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;    </div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;      }</div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;    </div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;        duration = micros()-thisTime;</div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;}</div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;<span class="keywordtype">void</span> SensorTimer::initializeVariablesForSleep(<span class="keywordtype">void</span>){</div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;    time_t current_time = time(NULL);</div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;    <span class="keyword">struct </span>tm *time_split = localtime(&amp;current_time);</div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;    <span class="keyword">struct </span>tm night_time_split = {0, 0, 22, time_split-&gt;tm_mday, </div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;        time_split-&gt;tm_mon, time_split-&gt;tm_year, time_split-&gt;tm_wday, time_split-&gt;tm_yday, time_split-&gt;tm_isdst};</div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;    <a class="code" href="classSensorTimer.html#a4d29fdf6804a4777668d957a8333f9c6">nightTime</a> = mktime(&amp;night_time_split);</div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;    <span class="keywordflow">if</span>(is_simulation)</div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;        <a class="code" href="classSensorTimer.html#a4d29fdf6804a4777668d957a8333f9c6">nightTime</a> = time(NULL) - 60;</div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;    time_t estimatedSleepLength = 60*60*8;</div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;    wakeTime = <a class="code" href="classSensorTimer.html#a4d29fdf6804a4777668d957a8333f9c6">nightTime</a> + estimatedSleepLength;</div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;}</div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160; </div>
<div class="line"><a name="l00321"></a><span class="lineno"><a class="line" href="classSensorTimer.html#a36233c0d18fe087bbfcf3a37bdf6dcec">  321</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="classSensorTimer.html#a36233c0d18fe087bbfcf3a37bdf6dcec">SensorTimer::analyzeBeatsForSleep</a>(<span class="keywordtype">int</span> bpm)</div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;{</div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;    <span class="keywordtype">bool</span> sleep_local = 0;</div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;    time_t maybeSleepTime;</div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;<span class="comment">  * if BPM is below a certain threshold</span></div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;<span class="comment">  * mayBeSleep should be on</span></div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;<span class="comment">  * if mayBeSleep is on for a while</span></div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;<span class="comment">  * then return 1;</span></div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;<span class="comment">  */</span></div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;    time_t now = time(NULL);</div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;    <span class="comment">//printf(&quot;BPM is %d, now is %d, nightTime is %d wakeTime is %d\n&quot;, BPM, now, nightTime, wakeTime);</span></div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;    <span class="keywordflow">if</span> (now &gt; <a class="code" href="classSensorTimer.html#a4d29fdf6804a4777668d957a8333f9c6">nightTime</a> &amp;&amp; now &lt; wakeTime) {</div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;        <span class="keywordflow">if</span> (bpm &lt; bpmThreshold &amp;&amp; maybeSleep == 0) {</div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;        printf(<span class="stringliteral">&quot;maybesleep Happened\n&quot;</span>);</div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;            startOfProspectiveSleep = time(NULL);</div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;            maybeSleep = 1;</div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;        }</div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;        <span class="keywordflow">if</span> (bpm &lt; bpmThreshold &amp;&amp; maybeSleep == 1) {</div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;            maybeSleepTime = time(NULL) - startOfProspectiveSleep;</div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;            <span class="keywordflow">if</span> (maybeSleepTime &gt; surelySleptTime) {</div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;                sleep_local = 1;</div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;            }</div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;        }</div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;        <span class="keywordflow">if</span> (bpm &gt; bpmThreshold &amp;&amp; maybeSleep == 1) {</div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;            maybeSleep = 0;</div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;        }</div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;    }</div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;    <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;        sleep_local = 0;</div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;    }</div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;<span class="comment">//    if(bpm &lt; 77)</span></div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;<span class="comment">//      sleep_local = 1;</span></div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;    <span class="keywordflow">return</span> sleep_local;</div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;}</div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160; </div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160; </div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160; </div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160; </div>
<div class="line"><a name="l00360"></a><span class="lineno"><a class="line" href="classSenseWindow.html">  360</a></span>&#160;<span class="keyword">class </span><a class="code" href="classSenseWindow.html">SenseWindow</a> : <span class="keyword">public</span> <a class="code" href="classMainWindow.html">MainWindow</a>{</div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;    <span class="keyword">private</span>:</div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;        <span class="keywordtype">int</span> Signal;</div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;    <span class="keyword">public</span>:</div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;        <a class="code" href="classSenseWindow.html">SenseWindow</a>(){</div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;        }</div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;    <span class="keywordtype">void</span> timerEvent( QTimerEvent * ) {</div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;        Signal = analogRead(BASE);</div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;        addRealtimeSample(Signal);</div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;        callPlot();</div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;    }</div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;};</div>
<div class="ttc" id="aclassCppTimer_html"><div class="ttname"><a href="classCppTimer.html">CppTimer</a></div><div class="ttdef"><b>Definition:</b> CppTimer.h:35</div></div>
<div class="ttc" id="aclassMainWindow_html"><div class="ttname"><a href="classMainWindow.html">MainWindow</a></div><div class="ttdef"><b>Definition:</b> mainwindow.h:20</div></div>
<div class="ttc" id="aclassSenseWindow_html"><div class="ttname"><a href="classSenseWindow.html">SenseWindow</a></div><div class="ttdef"><b>Definition:</b> PulseSensor.h:360</div></div>
<div class="ttc" id="aclassSensorCallback_html"><div class="ttname"><a href="classSensorCallback.html">SensorCallback</a></div><div class="ttdef"><b>Definition:</b> PulseSensor.h:12</div></div>
<div class="ttc" id="aclassSensorCallback_html_ac8bc6b4797f2e2b1d9612e1e1f834fbd"><div class="ttname"><a href="classSensorCallback.html#ac8bc6b4797f2e2b1d9612e1e1f834fbd">SensorCallback::hasSample</a></div><div class="ttdeci">virtual void hasSample(int beats, bool mayBeSleep)=0</div></div>
<div class="ttc" id="aclassSensorTimer_html"><div class="ttname"><a href="classSensorTimer.html">SensorTimer</a></div><div class="ttdef"><b>Definition:</b> PulseSensor.h:21</div></div>
<div class="ttc" id="aclassSensorTimer_html_a2b87e348b476be96d88ee70be98bef11"><div class="ttname"><a href="classSensorTimer.html#a2b87e348b476be96d88ee70be98bef11">SensorTimer::setCallback</a></div><div class="ttdeci">void setCallback(SensorCallback *cb)</div><div class="ttdef"><b>Definition:</b> PulseSensor.h:140</div></div>
<div class="ttc" id="aclassSensorTimer_html_a36233c0d18fe087bbfcf3a37bdf6dcec"><div class="ttname"><a href="classSensorTimer.html#a36233c0d18fe087bbfcf3a37bdf6dcec">SensorTimer::analyzeBeatsForSleep</a></div><div class="ttdeci">bool analyzeBeatsForSleep(int bpm)</div><div class="ttdef"><b>Definition:</b> PulseSensor.h:321</div></div>
<div class="ttc" id="aclassSensorTimer_html_a4d29fdf6804a4777668d957a8333f9c6"><div class="ttname"><a href="classSensorTimer.html#a4d29fdf6804a4777668d957a8333f9c6">SensorTimer::nightTime</a></div><div class="ttdeci">time_t nightTime</div><div class="ttdef"><b>Definition:</b> PulseSensor.h:47</div></div>
<div class="ttc" id="aclassSensorTimer_html_a6d15ff3f37f39e6baa43cf22a48263f2"><div class="ttname"><a href="classSensorTimer.html#a6d15ff3f37f39e6baa43cf22a48263f2">SensorTimer::timerEvent</a></div><div class="ttdeci">void timerEvent()</div><div class="ttdef"><b>Definition:</b> PulseSensor.h:145</div></div>
</div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
